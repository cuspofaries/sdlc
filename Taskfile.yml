version: '3'

# ============================================================================
# SDLC - Unified Supply Chain Security Toolchain
# ============================================================================
# Shift-left pipeline: build -> analyze -> publish
#
# Usage:
#   task install               â†’ Install all tools
#   task build                 â†’ Build container image (local, no push)
#   task sbom:generate         â†’ Generate image SBOM (CycloneDX)
#   task sbom:scan             â†’ Scan image for vulnerabilities
#   task sast:scan             â†’ Scan source code (SAST)
#   task sbom:policy           â†’ Enforce OPA policies
#   task opa:test              â†’ Run OPA unit tests
#   task push                  â†’ Push image to registry
#   task image:sign            â†’ Sign image digest (cosign)
#   task sbom:attest           â†’ Attest SBOM to image digest
#   task slsa:attest           â†’ Attest SLSA build provenance
#   task sbom:upload           â†’ Upload to Dependency-Track
#   task pipeline              â†’ Full pipeline (build -> analyze -> publish)
#   task pipeline:local        â†’ Local pipeline (build -> analyze, no publish)
#   task dtrack:up             â†’ Start Dependency-Track stack
#   task clean                 â†’ Cleanup generated files
# ============================================================================

vars:
  # -- Image --
  REGISTRY: '{{.REGISTRY | default "localhost:5000"}}'
  IMAGE_NAME: '{{.IMAGE_NAME | default "supply-chain-poc"}}'
  IMAGE_TAG: '{{.IMAGE_TAG | default "latest"}}'
  IMAGE: '{{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}'

  # -- SBOM --
  SBOM_FORMAT: cyclonedx-json
  SBOM_DIR: ./output/sbom
  SCAN_DIR: ./output/scans

  # -- Scan --
  TRIVY_EXIT_CODE: '{{.TRIVY_EXIT_CODE | default "1"}}'
  TRIVY_SEVERITY: '{{.TRIVY_SEVERITY | default "HIGH,CRITICAL"}}'

  # -- SAST --
  SAST_EXIT_CODE: '{{.SAST_EXIT_CODE | default "1"}}'
  SAST_SEVERITY: '{{.SAST_SEVERITY | default "ERROR"}}'
  SAST_CONFIG: '{{.SAST_CONFIG | default "p/owasp-top-ten"}}'
  SAST_CONTEXT: '{{.SAST_CONTEXT | default "./app"}}'

  # -- Policy --
  EXTRA_POLICIES: '{{.EXTRA_POLICIES | default ""}}'

  # -- Security Exceptions --
  EXCEPTIONS_FILE: '{{.EXCEPTIONS_FILE | default "security-exceptions.yaml"}}'

  # -- Dependency-Track --
  DTRACK_URL: '{{.DTRACK_URL | default "http://localhost:8081"}}'
  DTRACK_API_KEY: '{{.DTRACK_API_KEY | default ""}}'
  DTRACK_PROJECT: '{{.DTRACK_PROJECT | default "supply-chain-poc"}}'

  # -- Signing --
  COSIGN_KEY: ./cosign.key
  COSIGN_PUB: ./cosign.pub

  # -- Tool versions (pinned for reproducibility) --
  TRIVY_VERSION: '0.69.1'   # renovate: datasource=github-releases depName=aquasecurity/trivy
  COSIGN_VERSION: 'v3.0.4'  # renovate: datasource=github-releases depName=sigstore/cosign
  CDXGEN_VERSION: '10.10.7' # renovate: datasource=npm depName=@cyclonedx/cdxgen
  OPA_VERSION: 'v1.13.1'    # renovate: datasource=github-releases depName=open-policy-agent/opa
  ORAS_VERSION: '1.3.0'     # renovate: datasource=github-releases depName=oras-project/oras
  YQ_VERSION: 'v4.52.4'     # renovate: datasource=github-releases depName=mikefarah/yq
  SEMGREP_VERSION: '1.67.0'  # renovate: datasource=pypi depName=semgrep
  # Azure Key Vault KMS (recommended for enterprise)
  # Example: myorgvault.vault.azure.net/cosign-key
  COSIGN_KMS_KEY: '{{.COSIGN_KMS_KEY | default ""}}'

  # -- Air-gap deployment --
  # Set AIRGAP_DIR to generate cosign bundles during sign/attest for offline verification.
  # Empty = no bundles generated (default). Example: output/airgap
  AIRGAP_DIR: '{{.AIRGAP_DIR | default ""}}'
  AIRGAP_REGISTRY: '{{.AIRGAP_REGISTRY | default "localhost:5000"}}'

env:
  COSIGN_EXPERIMENTAL: "1"

tasks:

  # ==========================================================================
  # SETUP
  # ==========================================================================

  install:
    desc: "Install all SBOM tools"
    cmds:
      - task: install:trivy
      - task: install:cosign
      - task: install:cdxgen
      - task: install:opa
      - task: install:oras
      - task: install:yq
      - task: install:semgrep
      - echo "âœ… All tools installed"
      - task: install:verify

  install:trivy:
    desc: "Install Trivy {{.TRIVY_VERSION}}"
    cmds:
      - |
        for i in 1 2 3; do
          echo "Attempt $i to install trivy {{.TRIVY_VERSION}}..."
          if curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v{{.TRIVY_VERSION}}; then
            echo "âœ… Trivy {{.TRIVY_VERSION}} installed"
            break
          else
            echo "âš ï¸  Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          fi
          if [ $i -eq 3 ]; then
            echo "âŒ Failed to install trivy after 3 attempts"
            exit 1
          fi
        done
    status:
      - which trivy

  install:cosign:
    desc: "Install Cosign {{.COSIGN_VERSION}}"
    cmds:
      - |
        curl -sLO "https://github.com/sigstore/cosign/releases/download/{{.COSIGN_VERSION}}/cosign-linux-amd64"
        chmod +x cosign-linux-amd64
        sudo install -m 755 cosign-linux-amd64 /usr/local/bin/cosign
        rm -f cosign-linux-amd64
        echo "âœ… Cosign {{.COSIGN_VERSION}} installed"
    status:
      - which cosign

  install:cdxgen:
    desc: "Install cdxgen {{.CDXGEN_VERSION}}"
    cmds:
      - npm install -g @cyclonedx/cdxgen@{{.CDXGEN_VERSION}}
    status:
      - which cdxgen

  install:opa:
    desc: "Install OPA {{.OPA_VERSION}}"
    cmds:
      - |
        curl -sL -o opa "https://openpolicyagent.org/downloads/{{.OPA_VERSION}}/opa_linux_amd64_static"
        chmod +x opa
        sudo install -m 755 opa /usr/local/bin/opa
        rm -f opa
        echo "âœ… OPA {{.OPA_VERSION}} installed"
    status:
      - which opa

  install:oras:
    desc: "Install ORAS {{.ORAS_VERSION}}"
    cmds:
      - |
        curl -sLO "https://github.com/oras-project/oras/releases/download/v{{.ORAS_VERSION}}/oras_{{.ORAS_VERSION}}_linux_amd64.tar.gz"
        tar -xzf oras_{{.ORAS_VERSION}}_linux_amd64.tar.gz
        sudo install -m 755 oras /usr/local/bin/oras
        rm -f oras_{{.ORAS_VERSION}}_linux_amd64.tar.gz oras
        echo "âœ… ORAS {{.ORAS_VERSION}} installed"
    status:
      - which oras

  install:yq:
    desc: "Install yq {{.YQ_VERSION}} (YAML processor for security exceptions)"
    cmds:
      - |
        curl -sL -o yq "https://github.com/mikefarah/yq/releases/download/{{.YQ_VERSION}}/yq_linux_amd64"
        chmod +x yq
        sudo install -m 755 yq /usr/local/bin/yq
        rm -f yq
        echo "âœ… yq {{.YQ_VERSION}} installed"
    status:
      - which yq

  install:semgrep:
    desc: "Install Semgrep {{.SEMGREP_VERSION}}"
    cmds:
      - |
        python3 -m venv /opt/semgrep-venv
        /opt/semgrep-venv/bin/pip install semgrep=={{.SEMGREP_VERSION}}
        ln -sf /opt/semgrep-venv/bin/semgrep /usr/local/bin/semgrep
        echo "âœ… Semgrep {{.SEMGREP_VERSION}} installed"
    status:
      - which semgrep

  install:verify:
    desc: "Verify all tools are installed"
    cmds:
      - |
        echo "=== Tool Versions ==="
        echo -n "trivy:  " && trivy version 2>/dev/null | head -1 || echo "âŒ NOT INSTALLED"
        echo -n "cosign: " && cosign version 2>/dev/null | head -1 || echo "âŒ NOT INSTALLED"
        echo -n "cdxgen: " && cdxgen --version 2>/dev/null || echo "âŒ NOT INSTALLED"
        echo -n "opa:    " && opa version 2>/dev/null | head -1 || echo "âŒ NOT INSTALLED"
        echo -n "oras:   " && oras version 2>/dev/null | head -1 || echo "âŒ NOT INSTALLED"
        echo -n "yq:     " && yq --version 2>/dev/null | head -1 || echo "âŒ NOT INSTALLED"
        echo -n "semgrep: " && semgrep --version 2>/dev/null || echo "âŒ NOT INSTALLED"

  # ==========================================================================
  # PHASE 1 - BUILD
  # ==========================================================================

  build:
    desc: "Build container image (local only, no push)"
    cmds:
      - docker build -t {{.IMAGE}} ./app
      - echo "âœ… Image built {{.IMAGE}}"

  # ==========================================================================
  # PHASE 2 - ANALYZE
  # ==========================================================================
  # INVARIANT: The SBOM is generated, scanned, evaluated, and attested
  # from the EXACT SAME image. Never regenerate or modify the SBOM
  # between generation and attestation â€” this would break the guarantee
  # that "what we scanned = what we signed".

  sbom:generate:
    desc: "Generate image SBOM (CycloneDX) via trivy image"
    cmds:
      - mkdir -p {{.SBOM_DIR}}/image
      - |
        trivy image {{.IMAGE}} \
          --format cyclonedx \
          --output {{.SBOM_DIR}}/image/sbom-image-trivy.json
      - echo "âœ… Image SBOM â†’ {{.SBOM_DIR}}/image/sbom-image-trivy.json"

  sbom:generate:source:
    desc: "Generate source SBOM (declared deps)"
    cmds:
      - mkdir -p {{.SBOM_DIR}}/source
      - ./scripts/sbom-generate-source.sh ./app {{.SBOM_DIR}}/source
      - echo "âœ… Source SBOMs â†’ {{.SBOM_DIR}}/source/"

  sbom:generate:all:
    desc: "Generate both source + image SBOMs"
    cmds:
      - task: sbom:generate
      - task: sbom:generate:source
      - echo "âœ… Source + Image SBOMs generated"

  sbom:scan:
    desc: "Scan image for vulnerabilities (trivy image direct)"
    cmds:
      - mkdir -p {{.SCAN_DIR}}
      - |
        IGNOREFILE_FLAG=""
        if [ -f "{{.EXCEPTIONS_FILE}}" ]; then
          echo "â”€â”€ Generating .trivyignore from security exceptions â”€â”€"
          ./scripts/trivy-exceptions.sh "{{.EXCEPTIONS_FILE}}" .trivyignore
          IGNOREFILE_FLAG="--ignorefile .trivyignore"
          echo ""
        fi
        trivy image {{.IMAGE}} \
          --severity {{.TRIVY_SEVERITY}} \
          --exit-code {{.TRIVY_EXIT_CODE}} \
          --format json \
          --output {{.SCAN_DIR}}/scan-trivy.json \
          $IGNOREFILE_FLAG
        trivy image {{.IMAGE}} \
          --severity {{.TRIVY_SEVERITY}} \
          --exit-code {{.TRIVY_EXIT_CODE}} \
          $IGNOREFILE_FLAG
      - echo "âœ… Vulnerability scan complete â†’ {{.SCAN_DIR}}/scan-trivy.json"

  sbom:scan:sbom:
    desc: "Scan SBOM for vulnerabilities (trivy sbom â€” governance alignment)"
    cmds:
      - mkdir -p {{.SCAN_DIR}}
      - |
        trivy sbom {{.SBOM_DIR}}/image/sbom-image-trivy.json \
          --severity {{.TRIVY_SEVERITY}} \
          --exit-code 0 \
          --format json \
          --output {{.SCAN_DIR}}/scan-sbom-trivy.json
      - |
        trivy sbom {{.SBOM_DIR}}/image/sbom-image-trivy.json \
          --severity {{.TRIVY_SEVERITY}} \
          --exit-code 0
      - echo "âœ… SBOM scan complete (advisory) â†’ {{.SCAN_DIR}}/scan-sbom-trivy.json"

  sast:scan:
    desc: "Scan source code for security issues (Semgrep SAST)"
    cmds:
      - mkdir -p {{.SCAN_DIR}}
      - |
        echo "ðŸ” SAST scan: {{.SAST_CONTEXT}}"
        echo "   Config:   {{.SAST_CONFIG}}"
        echo "   Severity: {{.SAST_SEVERITY}}"
        semgrep scan {{.SAST_CONTEXT}} \
          --config {{.SAST_CONFIG}} \
          --severity {{.SAST_SEVERITY}} \
          --json --json-output={{.SCAN_DIR}}/scan-sast.json \
          --error
        echo "âœ… SAST scan passed â†’ {{.SCAN_DIR}}/scan-sast.json"

  opa:test:
    desc: "Run OPA unit tests on policy rules"
    cmds:
      - opa test policies/ -v
      - echo "âœ… OPA policy tests passed"

  exceptions:validate:
    desc: "Validate security-exceptions.yaml (format + expiry)"
    cmds:
      - |
        if [ ! -f "{{.EXCEPTIONS_FILE}}" ]; then
          echo "â„¹ï¸  No exceptions file at {{.EXCEPTIONS_FILE}} â€” nothing to validate"
          exit 0
        fi
        if ! command -v yq &>/dev/null; then
          echo "âŒ yq is not installed. Run: task install:yq" >&2
          exit 1
        fi
        echo "â”€â”€ Validating {{.EXCEPTIONS_FILE}} â”€â”€"
        EXCEPTIONS_JSON=$(mktemp)
        yq -o json "{{.EXCEPTIONS_FILE}}" > "$EXCEPTIONS_JSON"
        opa eval \
          -d ./policies/ \
          --data "$EXCEPTIONS_JSON" \
          -i /dev/null \
          'data.sbom.deny' \
          --format raw
        rm -f "$EXCEPTIONS_JSON"
        echo "âœ… Exceptions validation complete"

  sbom:policy:
    desc: "Evaluate SBOM against OPA policies (baseline + optional custom)"
    cmds:
      - |
        EXCEPTIONS_ARG=""
        if [ -f "{{.EXCEPTIONS_FILE}}" ]; then
          EXCEPTIONS_ARG="{{.EXCEPTIONS_FILE}}"
        fi
        ./scripts/sbom-policy.sh {{.SBOM_DIR}}/image/sbom-image-trivy.json ./policies "{{.EXTRA_POLICIES}}" "$EXCEPTIONS_ARG"

  # ==========================================================================
  # PHASE 3 - PUBLISH
  # ==========================================================================

  push:
    desc: "Push image to registry"
    cmds:
      - docker push {{.IMAGE}}
      - echo "âœ… Image pushed {{.IMAGE}}"

  image:sign:
    desc: "Sign image digest with cosign (KMS > CI keyless > keypair)"
    cmds:
      - COSIGN_KMS_KEY="{{.COSIGN_KMS_KEY}}" AIRGAP_BUNDLE_DIR="{{.AIRGAP_DIR}}" ./scripts/image-sign.sh {{.IMAGE}} {{.COSIGN_KEY}}

  image:verify:
    desc: "Verify image signature (KMS > keypair > keyless)"
    cmds:
      - COSIGN_KMS_KEY="{{.COSIGN_KMS_KEY}}" ./scripts/image-verify.sh {{.IMAGE}} {{.SCAN_DIR}} {{.COSIGN_PUB}}

  # ==========================================================================
  # SBOM SIGNING & ATTESTATION
  # ==========================================================================

  signing:init:
    desc: "Generate Cosign keypair (POC only - use keyless in prod)"
    cmds:
      - COSIGN_PASSWORD="" cosign generate-key-pair
      - echo "âœ… Keypair generated â†’ cosign.key / cosign.pub"
    status:
      - test -f cosign.key
      - test -f cosign.pub

  slsa:attest:
    desc: "Attest SLSA build provenance to image digest"
    cmds:
      - COSIGN_KMS_KEY="{{.COSIGN_KMS_KEY}}" AIRGAP_BUNDLE_DIR="{{.AIRGAP_DIR}}" ./scripts/slsa-provenance.sh {{.IMAGE}} {{.COSIGN_KEY}}

  sbom:attest:
    desc: "Attest image SBOM to image digest (strongest â€” requires registry)"
    cmds:
      - COSIGN_KMS_KEY="{{.COSIGN_KMS_KEY}}" AIRGAP_BUNDLE_DIR="{{.AIRGAP_DIR}}" ./scripts/sbom-attest.sh {{.IMAGE}} {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.COSIGN_KEY}}

  sbom:attest:verify:
    desc: "Verify signature and attestation are published in the registry"
    cmds:
      - COSIGN_KMS_KEY="{{.COSIGN_KMS_KEY}}" ./scripts/image-verify.sh {{.IMAGE}} {{.SCAN_DIR}} {{.COSIGN_PUB}}

  sbom:sign:blob:
    desc: "Sign SBOM as standalone blob (fallback â€” no registry needed)"
    deps: [signing:init]
    cmds:
      - |
        for sbom in {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.SBOM_DIR}}/source/sbom-source-cdxgen.json; do
          if [ -f "$sbom" ]; then
            cosign sign-blob \
              --key {{.COSIGN_KEY}} \
              --output-signature "${sbom}.sig" \
              "$sbom" --yes 2>/dev/null
            echo "âœ… Signed â†’ ${sbom}.sig"
          fi
        done

  sbom:sign:
    desc: "Sign SBOM (auto: attest if registry reachable, blob otherwise)"
    deps: [signing:init]
    cmds:
      - ./scripts/sbom-sign.sh {{.IMAGE}} {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.COSIGN_KEY}}

  sbom:upload:
    desc: "Upload attested SBOM to Dependency-Track (non-blocking monitoring)"
    cmds:
      - ./scripts/sbom-upload-dtrack.sh {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.DTRACK_URL}} {{.DTRACK_API_KEY}} {{.DTRACK_PROJECT}} {{.IMAGE}}

  # ==========================================================================
  # SBOM VERIFICATION
  # ==========================================================================

  sbom:verify:
    desc: "Verify SBOM signature and integrity"
    cmds:
      - ./scripts/sbom-verify.sh {{.IMAGE}} {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.COSIGN_PUB}}

  sbom:verify:blob:
    desc: "Verify standalone SBOM blob signature"
    cmds:
      - |
        cosign verify-blob \
          --key {{.COSIGN_PUB}} \
          --signature {{.SBOM_DIR}}/image/sbom-image-trivy.json.sig \
          {{.SBOM_DIR}}/image/sbom-image-trivy.json
      - echo "âœ… SBOM signature valid"

  sbom:tamper:test:
    desc: "Simulate SBOM tampering (demo integrity check)"
    cmds:
      - ./scripts/sbom-tamper-test.sh {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.COSIGN_PUB}}

  # ==========================================================================
  # SBOM STORAGE (OCI Registry)
  # ==========================================================================

  sbom:store:
    desc: "Store SBOM as OCI artifact in registry"
    cmds:
      - |
        oras push {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}-sbom \
          --artifact-type application/vnd.cyclonedx+json \
          {{.SBOM_DIR}}/image/sbom-image-trivy.json:application/json
      - echo "âœ… SBOM stored â†’ {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}-sbom"

  sbom:fetch:
    desc: "Fetch SBOM from OCI registry"
    cmds:
      - mkdir -p {{.SBOM_DIR}}/fetched
      - |
        oras pull {{.REGISTRY}}/{{.IMAGE_NAME}}:{{.IMAGE_TAG}}-sbom \
          -o {{.SBOM_DIR}}/fetched/
      - echo "âœ… SBOM fetched â†’ {{.SBOM_DIR}}/fetched/"

  # ==========================================================================
  # DEPENDENCY-TRACK
  # ==========================================================================

  dtrack:up:
    desc: "Start Dependency-Track (docker compose)"
    cmds:
      - docker compose -f docker-compose.dtrack.yml up -d
      - echo "âœ… Dependency-Track starting â†’ http://localhost:8081"
      - echo "   Default credentials - admin / admin"
      - echo "   â³ First startup takes 2-3 minutes..."

  dtrack:down:
    desc: "Stop Dependency-Track"
    cmds:
      - docker compose -f docker-compose.dtrack.yml down

  # ==========================================================================
  # FULL PIPELINES
  # ==========================================================================

  pipeline:
    desc: "Full supply chain pipeline (build -> analyze -> GATE -> publish)"
    cmds:
      - echo "ðŸš€ Starting full supply chain pipeline..."
      - echo "=== PHASE 1 - BUILD ==="
      - task: build
      - echo ""
      - echo "=== PHASE 2 - ANALYZE ==="
      - task: sbom:generate
      - task: sbom:scan
      - task: sast:scan
      - task: sbom:policy
      - echo ""
      - echo "=== GATE PASSED ==="
      - echo ""
      - echo "=== SBOM GOVERNANCE ==="
      - task: sbom:scan:sbom
      - echo ""
      - echo "=== PHASE 3 - PUBLISH ==="
      - task: push
      - task: image:sign
      - task: sbom:attest
      - task: slsa:attest
      - task: sbom:attest:verify
      - task: sbom:upload
      - echo ""
      - echo "=================================================="
      - echo "âœ… Pipeline complete. Outputs in ./output/"
      - echo "=================================================="

  pipeline:local:
    desc: "Local pipeline (build -> analyze, no publish)"
    cmds:
      - echo "ðŸš€ Starting local pipeline..."
      - echo "=== PHASE 1 - BUILD ==="
      - task: build
      - echo ""
      - echo "=== PHASE 2 - ANALYZE ==="
      - task: sbom:generate
      - task: sbom:scan
      - task: sast:scan
      - task: sbom:policy
      - echo ""
      - echo "=== SBOM GOVERNANCE ==="
      - task: sbom:scan:sbom
      - echo ""
      - echo "=================================================="
      - echo "âœ… Local pipeline complete (no publish)."
      - echo "Outputs in ./output/"
      - echo "=================================================="

  # ==========================================================================
  # AIR-GAP DEPLOYMENT
  # ==========================================================================

  airgap:export:
    desc: "Package signed image + cosign bundles for air-gapped deployment"
    cmds:
      - ./scripts/airgap-export.sh {{.IMAGE}} {{.SBOM_DIR}}/image/sbom-image-trivy.json {{.AIRGAP_EXPORT_DIR}} {{.COSIGN_PUB}}
    vars:
      AIRGAP_EXPORT_DIR: '{{.AIRGAP_DIR | default "output/airgap"}}'

  airgap:verify:
    desc: "Verify image signature + attestations from air-gap package (offline)"
    cmds:
      - ./scripts/airgap-verify.sh {{.AIRGAP_VERIFY_DIR}} {{.AIRGAP_REGISTRY}}
    vars:
      AIRGAP_VERIFY_DIR: '{{.AIRGAP_DIR | default "output/airgap"}}'

  # ==========================================================================
  # CLEANUP
  # ==========================================================================

  clean:
    desc: "Remove all generated files"
    cmds:
      - rm -rf ./output
      - echo "âœ… Cleaned output directory"

  clean:all:
    desc: "Remove everything (output + keys)"
    cmds:
      - rm -rf ./output cosign.key cosign.pub
      - echo "âœ… Full cleanup done"
